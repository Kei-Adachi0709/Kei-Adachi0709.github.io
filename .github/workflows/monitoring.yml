name: ðŸ” Monitoring & Health Check

on:
  schedule:
    # æ¯Žæ—¥9æ™‚ï¼ˆJSTï¼‰ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [health-check]

env:
  SITE_URL: https://kei-adachi0709.github.io

jobs:
  health-check:
    name: ðŸ¥ Website Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŒ Check website availability
        run: |
          echo "ðŸ” ã‚µã‚¤ãƒˆã®å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯ä¸­..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.SITE_URL }})
          if [ $response -eq 200 ]; then
            echo "âœ… ã‚µã‚¤ãƒˆã¯æ­£å¸¸ã«ç¨¼åƒä¸­ (HTTP $response)"
          else
            echo "âŒ ã‚µã‚¤ãƒˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™ (HTTP $response)"
            exit 1
          fi

      - name: ðŸš€ Performance check with Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            ${{ env.SITE_URL }}
          configPath: ./.lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ðŸ”’ Security headers check
        run: |
          echo "ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ä¸­..."
          curl -I ${{ env.SITE_URL }} | grep -E "(X-Frame-Options|X-Content-Type-Options|X-XSS-Protection|Strict-Transport-Security)" || echo "âš ï¸ ä¸€éƒ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"

      - name: ðŸ”— Link check
        uses: lycheeverse/lychee-action@v1.8.0
        with:
          args: --verbose --no-progress ${{ env.SITE_URL }}
          fail: true

      - name: ðŸ“Š Generate report
        if: always()
        run: |
          echo "ðŸ“Š ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          cat > health-report.md << EOF
          # ðŸ” Website Health Report
          
          **Date:** $(date)
          **Site:** ${{ env.SITE_URL }}
          
          ## Results
          - âœ… Availability Check
          - âœ… Performance Check
          - âœ… Security Headers
          - âœ… Link Validation
          
          ## Next Check
          ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: æ¯Žæ—¥ 9:00 JST
          EOF

      - name: ðŸ“¨ Notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ðŸš¨ **ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆ** ðŸš¨
            
            ã‚µã‚¤ãƒˆ: ${{ env.SITE_URL }}
            æ™‚åˆ»: $(date)
            
            ä½•ã‚‰ã‹ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  seo-check:
    name: ðŸŽ¯ SEO & Accessibility Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŽ¯ SEO analysis
        run: |
          echo "ðŸŽ¯ SEOåˆ†æžä¸­..."
          # ãƒ¡ã‚¿ã‚¿ã‚°ã€æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã€ã‚µã‚¤ãƒˆãƒžãƒƒãƒ—ãªã©ã‚’ãƒã‚§ãƒƒã‚¯
          curl -s ${{ env.SITE_URL }} | grep -E "(title|meta name=\"description\"|meta property=\"og:)" || echo "âš ï¸ SEOè¦ç´ ã®æ”¹å–„ãŒå¿…è¦ã§ã™"

      - name: â™¿ Accessibility check
        run: |
          echo "â™¿ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­..."
          # åŸºæœ¬çš„ãªã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯
          curl -s ${{ env.SITE_URL }} | grep -E "(alt=|aria-|role=)" || echo "âš ï¸ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®æ”¹å–„ãŒå¿…è¦ã§ã™"

  backup-check:
    name: ðŸ’¾ Backup Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ’¾ Repository backup check
        run: |
          echo "ðŸ’¾ ãƒªãƒã‚¸ãƒˆãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ³ç¢ºèªä¸­..."
          # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã¨ãƒ–ãƒ©ãƒ³ãƒçŠ¶æ³ã‚’ç¢ºèª
          git log --oneline -5
          git branch -a

      - name: ðŸ“ˆ Repository stats
        run: |
          echo "ðŸ“ˆ ãƒªãƒã‚¸ãƒˆãƒªçµ±è¨ˆæƒ…å ±:"
          echo "- ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find . -type f | wc -l)"
          echo "- ç·ã‚µã‚¤ã‚º: $(du -sh . | cut -f1)"
          echo "- æœ€æ–°æ›´æ–°: $(git log -1 --format='%cd' --date=short)"

  dependency-check:
    name: ðŸ” Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ”’ Security audit
        run: |
          echo "ðŸ”’ ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¸­..."
          npm audit --audit-level=moderate || echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

      - name: ðŸ“Š Dependency report
        run: |
          echo "ðŸ“Š ä¾å­˜é–¢ä¿‚ãƒ¬ãƒãƒ¼ãƒˆ:"
          npm list --depth=0 | head -20
