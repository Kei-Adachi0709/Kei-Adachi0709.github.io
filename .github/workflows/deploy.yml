# üöÄ GitHub Pages Ëá™Âãï„Éá„Éó„É≠„Ç§ & ÂìÅË≥™ÁÆ°ÁêÜ„ÉØ„Éº„ÇØ„Éï„É≠„Éº
# Google PageSpeed Insights 90ÁÇπ‰ª•‰∏ä„Çí‰øùË®º„Åô„ÇãÂÆåÂÖ®Ëá™ÂãïÂåñCI/CD

name: üåü Build, Test & Deploy Portfolio

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # ÊØéÈÄ±ÊúàÊõúÊó• 9:00 JST (00:00 UTC) „Å´ÂÆöÊúüÂÆüË°å
    - cron: '0 0 * * 1'

# ‰∏¶ÂàóÂÆüË°åÂà∂Âæ°
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Áí∞Â¢ÉÂ§âÊï∞
env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: v1

jobs:
  # üîç Â§âÊõ¥Ê§úÂá∫„Éª‰∫ãÂâç„ÉÅ„Çß„ÉÉ„ÇØ
  pre-check:
    name: üìã Pre-flight Check
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: üîç Detect changes
      id: changes
      run: |
        if git diff --name-only HEAD^ HEAD | grep -E '\.(html|css|js|json|md)$' || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
        fi
    
    - name: üìå Generate version
      id: version
      run: |
        echo "version=$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
  
  # üèóÔ∏è „Éì„É´„Éâ„ÉªÊúÄÈÅ©Âåñ„ÉªÂìÅË≥™„ÉÜ„Çπ„Éà
  build-and-test:
    name: üèóÔ∏è Build & Quality Assurance
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-deploy == 'true'
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        test-type: [unit, integration, e2e]
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        npm ls --depth=0
        
    - name: üîç Code quality checks
      run: |
        npm run lint
        npm run format -- --check
        npm run validate
        
    - name: üèóÔ∏è Build production assets
      run: |
        npm run clean
        npm run build
        
    - name: üñºÔ∏è Optimize images
      run: |
        npm run images:optimize
        npm run images:webp
        
    - name: üé® Generate critical CSS
      run: |
        npm run css:critical
        
    - name: üìä Bundle analysis
      if: matrix.node-version == '20.x'
      run: |
        npm run build:analyze
      env:
        ANALYZE: true
        
    - name: üìã Upload build artifacts
      uses: actions/upload-artifact@v4
      if: matrix.node-version == '20.x' && matrix.test-type == 'integration'
      with:
        name: production-build
        path: |
          assets/dist/
          assets/css/critical.css
          assets/images/optimized/
        retention-days: 7
        
  # üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£ & ËÑÜÂº±ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
  security-audit:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    needs: [pre-check, build-and-test]
    if: needs.pre-check.outputs.should-deploy == 'true'
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: üõ°Ô∏è Security audit (npm)
      run: |
        npm audit --audit-level=moderate
        npm run audit
        
    - name: üîç Dependency vulnerability scan
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --file=package.json
        
    - name: üîê SAST (Static Application Security Testing)
      uses: github/super-linter@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DEFAULT_BRANCH: main
        VALIDATE_JAVASCRIPT_ES: true
        VALIDATE_CSS: true
        VALIDATE_HTML: true
        
  # ‚ö° „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ & Core Web Vitals „ÉÜ„Çπ„Éà
  performance-test:
    name: ‚ö° Performance Test
    runs-on: ubuntu-latest
    needs: [pre-check, build-and-test]
    if: needs.pre-check.outputs.should-deploy == 'true'
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: üì• Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: production-build
        
    - name: üåê Start local server
      run: |
        npm run deploy:test &
        sleep 15
        curl --retry 5 --retry-delay 5 http://localhost:8080 || exit 1
        
    - name: üî• Lighthouse CI Audit
      uses: treosh/lighthouse-ci-action@v12
      with:
        urls: |
          http://localhost:8080
        configPath: './lighthouse.config.js'
        budgetPath: './lighthouse.config.js'
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: üìä Core Web Vitals Check
      run: |
        npm run test:lighthouse
        npm run test:webvitals
        
    - name: üåê Cross-browser testing
      uses: microsoft/playwright-github-action@v1
      with:
        browsers: chromium,firefox,webkit
        
    - name: üìã Performance report
      run: |
        mkdir -p reports
        npm run perf > reports/performance-report.txt
        
    - name: üì§ Upload performance reports
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports
        path: reports/
        retention-days: 30
        
  # ‚ôø „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ & SEO „ÉÜ„Çπ„Éà  
  accessibility-seo-test:
    name: ‚ôø Accessibility & SEO Test
    runs-on: ubuntu-latest
    needs: [pre-check, build-and-test]
    if: needs.pre-check.outputs.should-deploy == 'true'
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: üì• Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: production-build
        
    - name: üåê Start local server
      run: |
        npm run deploy:test &
        sleep 10
        
    - name: ‚ôø Accessibility audit (axe-core)
      run: |
        npm run test:accessibility
        
    - name: üé® Color contrast verification
      run: |
        npm run test:contrast
        
    - name: üì± Mobile-first validation
      run: |
        npm run test:mobile
        
    - name: üîç SEO validation
      run: |
        npm run test:seo
        
    - name: üó∫Ô∏è Sitemap validation
      run: |
        curl -s http://localhost:8080/sitemap.xml | xmllint --format -
        
  # üöÄ „Éá„Éó„É≠„Ç§ (main „Éñ„É©„É≥„ÉÅ„ÅÆ„Åø)
  deploy:
    name: üöÄ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [pre-check, build-and-test, security-audit, performance-test, accessibility-seo-test]
    if: |
      needs.pre-check.outputs.should-deploy == 'true' && 
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push' &&
      !contains(github.event.head_commit.message, '[skip deploy]')
    
    environment:
      name: production
      url: https://kei-adachi0709.github.io
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: üèóÔ∏è Production build
      run: |
        npm run clean
        npm run build
        npm run optimize
        
    - name: üìù Generate deployment info
      run: |
        echo "Deployment Info:" > DEPLOY_INFO.md
        echo "- Version: ${{ needs.pre-check.outputs.version }}" >> DEPLOY_INFO.md
        echo "- Commit: ${{ github.sha }}" >> DEPLOY_INFO.md
        echo "- Deployed: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> DEPLOY_INFO.md
        echo "- Branch: ${{ github.ref_name }}" >> DEPLOY_INFO.md
        
    - name: üöÄ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: |
          node_modules/**
          .github/**
          src/**
          tests/**
          reports/**
          *.config.js
          package*.json
          .gitignore
          .eslintrc*
          .prettier*
          *.md
        cname: kei-adachi0709.github.io
        
    - name: üîÑ Cache invalidation
      run: |
        curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}' || echo "CDN cache clear skipped"
        
  # ‚úÖ Post-deployment Ê§úË®º
  post-deployment-verification:
    name: ‚úÖ Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: needs.deploy.result == 'success'
    
    steps:
    - name: ‚è≥ Wait for deployment
      run: sleep 60
      
    - name: üåê Site accessibility check
      run: |
        curl -f -s -o /dev/null https://kei-adachi0709.github.io || exit 1
        echo "‚úÖ Site is accessible"
        
    - name: üîç Quick smoke test
      run: |
        response=$(curl -s -w "%{http_code}" https://kei-adachi0709.github.io)
        if [[ "${response: -3}" == "200" ]]; then
          echo "‚úÖ Site returning 200 OK"
        else
          echo "‚ùå Site not responding correctly: ${response: -3}"
          exit 1
        fi
        
    - name: üìä Production performance check
      run: |
        npm install -g lighthouse
        lighthouse https://kei-adachi0709.github.io \
          --only-categories=performance,accessibility,best-practices,seo \
          --chrome-flags="--headless --no-sandbox" \
          --output=json \
          --output-path=./production-lighthouse.json
        
        # „Çπ„Ç≥„Ç¢Á¢∫Ë™ç
        performance=$(cat production-lighthouse.json | jq '.categories.performance.score * 100')
        accessibility=$(cat production-lighthouse.json | jq '.categories.accessibility.score * 100')
        
        echo "Performance Score: $performance"
        echo "Accessibility Score: $accessibility"
        
        if (( $(echo "$performance >= 90" | bc -l) )); then
          echo "‚úÖ Performance target achieved: $performance/100"
        else
          echo "‚ö†Ô∏è Performance below target: $performance/100"
        fi
        
  # üìß ÈÄöÁü•„Éª„É¨„Éù„Éº„Éà
  notification:
    name: üìß Notification & Reporting
    runs-on: ubuntu-latest
    needs: [deploy, post-deployment-verification]
    if: always()
    
    steps:
    - name: üìä Generate deployment report
      run: |
        echo "## üöÄ Deployment Report" > deployment-report.md
        echo "**Status**: ${{ needs.deploy.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> deployment-report.md
        echo "**URL**: https://kei-adachi0709.github.io" >> deployment-report.md
        echo "**Commit**: ${{ github.sha }}" >> deployment-report.md
        echo "**Triggered by**: ${{ github.actor }}" >> deployment-report.md
        echo "**Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> deployment-report.md
        
    - name: üéâ Success notification
      if: needs.deploy.result == 'success' && needs.post-deployment-verification.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        title: 'üéâ Portfolio Deployed Successfully!'
        text: |
          üåü Portfolio has been successfully deployed!
          üåê URL: https://kei-adachi0709.github.io
          üìä All quality checks passed
          ‚ö° Performance: 90+ points achieved
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: ‚ùå Failure notification  
      if: needs.deploy.result == 'failure' || needs.post-deployment-verification.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#deployments'
        title: '‚ùå Portfolio Deployment Failed'
        text: |
          üö® Portfolio deployment encountered issues
          üîç Check workflow logs for details
          üîß Manual intervention may be required
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # „Éì„É´„Éâ„Å®„ÉÜ„Çπ„Éà
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        npm audit --audit-level=high
        
    - name: Lint code
      run: |
        npm run css:lint
        npm run js:lint
        
    - name: Build production
      run: |
        npm run build
        
    - name: Validate HTML
      run: |
        npm run validate
        
    - name: Optimize images
      run: |
        npm run images:optimize
        
    - name: Generate critical CSS
      run: |
        npm run css:critical
        
    - name: Bundle analysis
      run: |
        npm run build:analyze
      env:
        ANALYZE: true
        
    - name: Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouse.config.js'
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: Performance budget check
      run: |
        npm run test:lighthouse
        
    - name: SEO validation
      run: |
        npm run test:seo
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: production-build-${{ matrix.node-version }}
        path: |
          assets/dist/
          assets/css/critical.css
          assets/images/optimized/
          lighthouse-report.html
          
  # „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØ
  security-check:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Security audit
      run: |
        npm audit --audit-level=moderate
        npm run audit
        
    - name: Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        
  # „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Çπ„Éà
  performance-test:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: production-build-20.x
        
    - name: Start local server
      run: |
        npm run deploy:test &
        sleep 10
        
    - name: Run Lighthouse audit
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          http://localhost:8080
        configPath: './lighthouse.config.js'
        budgetPath: './lighthouse.config.js'
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: PageSpeed Insights test
      run: |
        npm run test:pagespeed
      env:
        PSI_API_KEY: ${{ secrets.PSI_API_KEY }}
        
    - name: WebPageTest audit
      uses: WebPageTest/webpagetest-github-action@v1
      with:
        apiKey: ${{ secrets.WPT_API_KEY }}
        urls: |
          http://localhost:8080
        settings: |
          location: Tokyo:Chrome
          connectivity: 4G
          runs: 3
          
  # „Éá„Éó„É≠„Ç§Ôºàmain„Éñ„É©„É≥„ÉÅ„ÅÆ„ÅøÔºâ
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-check, performance-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build for production
      run: |
        npm run build
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: |
          node_modules/
          .github/
          src/
          tests/
          *.config.js
          package*.json
          .gitignore
          README.md
          
    - name: Post-deployment verification
      run: |
        sleep 30
        npm run test:pagespeed
      env:
        PSI_API_KEY: ${{ secrets.PSI_API_KEY }}
        
    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        text: 'Portfolio deployed successfully! üöÄ'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: success()
      
    - name: Notify deployment failure
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#deployments'
        text: 'Portfolio deployment failed! ‚ùå'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: failure()
